<%= turbo_stream_from current_group, "properties" %>
<main class="container mb-xxxxl">
  <div class="property__nav-link">
    <%= link_to sanitize("&larr; Back to properties"), properties_path %>
<!--
    https://turbo.hotwired.dev/handbook/drive#preload-links-into-the-cache
    <a href="/properties" data-turbo-preload>Back to properties</a>
-->
    <%= link_to sanitize("PDF &rarr;"), property_path(@property, format: :pdf), data: { turbo_frame: "_top" } %>
  </div>
  <div class="header">
    <h1>
      <%= @property.name %>
    </h1>
    <% if @property.property_template and @property.property_template.to_i == 0 %>
      <p class="property__hint">This is a town house, shared, apartments style property template. Changes made here will be broadcasted to its <%= @property.associated_count(current_group) %> associated properties.</p>
    <% end %>
    <% if @property.property_template and @property.property_template.to_i != 0 %>
      <p class="property__hint">This property is also receiving changes from the <%= current_group.properties.where(id: @property.property_template.to_i).first.name %> broadcast.</p>
    <% end %>
    <div class="property__actions">
      <%= link_to "New space",
                  new_property_space_path(@property),
                  data: { turbo_frame: dom_id(Space.new) },
                  class: "btn btn--primary headerLink" %>  
<!--
      <section>
        <form action="<%# new_property_space_path(@property) %>" class="hidden sm:block" data-turbo-frame="dialog">
          <button name="turbo_frame" value="dialog" aria-expanded="false">Select from ideas</button>
        </form>
      </section>
-->
      <%= simple_form_for [@property], html: { class: "form--property-dropdown" } do |f| %>
        <%= form_error_notification(@property) %>
        <div data-controller="element search-params">
          <%= f.select :name, @property.styles.invert, { disabled: [@property.styles.keys[4], @property.styles.keys[5], @property.styles.keys[7], @property.styles.keys[8], @property.styles.keys[9], @property.styles.keys[11], @property.styles.keys[12], @property.styles.keys[14], @property.styles.keys[15]] }, autocomplete: "off", data: { action: "change->search-params#encode change->element#click" }, class: "property__select" %>
          <noscript>
            <button formmethod="get" formaction="<%= property_path(@property) %>">Select style</button>
          </noscript>
          <a href="<%= property_path(@property) %>" 
             hidden
             data-search-params-target="anchor"
             data-element-target="click" 
             data-turbo-frame="<%= dom_id(@property) %>"></a> 
<!--          <span>Tip: Use the dropdown tools here to change views and create templates!</span>-->
        </div>
      <% end %>   
    </div>
  </div>
     
  <%= turbo_frame_tag @property do %>
<!--    <div class="space__body">-->    
    <%= turbo_frame_tag Space.new %>
    <%= turbo_frame_tag "spaces" do %>
      <%= render "spaces/empty_state" %>
      <%= render @spaces, property: @property %>
    <% end %>
    <div class="header">
      <h1>
      </h1>
      <div class="property__actions"> 
        <%= link_to "New appliance",
                    new_property_appliance_path(@property),
                    data: { turbo_frame: dom_id(Appliance.new) },
                    class: "btn btn--primary" %>  
      </div>
    </div>
    <%= turbo_frame_tag Appliance.new %>
    <%= turbo_frame_tag "appliances" do %>
      <%= render "appliances/empty_state" %>
      <%= render @appliances, property: @property %>
    <% end %> 
    <% if params.dig(:property, :name) == "List interiors" or params.dig(:property, :name) == "List exteriors" %>
      <turbo-stream action="replace" targets=".headerLink">
        <template>
          <%= link_to "New space",
                      new_property_space_path(@property, location: "#{params.dig(:property, :name)}"),
                      data: { turbo_frame: dom_id(Space.new) },
                      class: "btn btn--primary headerLink" %>
        </template>
      </turbo-stream>
      <turbo-stream action="replace" targets=".emptyStateLink">
        <template>
          <%= link_to "Add space",
                      new_property_space_path(@property, location: "#{params.dig(:property, :name)}"),
                      data: { turbo_frame: dom_id(Space.new) },
                      class: "btn btn--primary emptyStateLink" %>
        </template>
      </turbo-stream>
    <% else %>
      <turbo-stream action="replace" targets=".headerLink">
        <template>
          <%= link_to "New space",
                      new_property_space_path(@property),
                      data: { turbo_frame: dom_id(Space.new) },
                      class: "btn btn--primary headerLink" %>
        </template>
      </turbo-stream>
      <turbo-stream action="replace" targets=".emptyStateLink">
        <template>
          <%= link_to "Add space",
                      new_property_space_path(@property),
                      data: { turbo_frame: dom_id(Space.new) },
                      class: "btn btn--primary emptyStateLink" %>
        </template>
      </turbo-stream>
    <% end %>
<!--    </div>-->
  <% end %>
</main>

<%= turbo_frame_tag dom_id(@property, :total) do %>
  <%= render "properties/total", property: @property %>
<% end %>